<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { margin:0; font-family:sans-serif; background:#0b0d14; color:#cfd3dc }
      .wrap { padding:14px }
      h3 { margin:0; padding:12px 14px; border-bottom:1px solid #1f2330 }
      label { display:block; font-size:12px; margin-top:8px }
      input, select { width:100%; box-sizing:border-box; background:#121623; color:#e6e6e6; border:1px solid #2a3040; border-radius:8px; padding:8px 10px; outline:none }
      input:focus, select:focus { border-color:#3a4160; box-shadow:0 0 0 3px rgba(42,48,64,.35) }
      .row { display:flex; gap:8px }
      .row > div { flex:1 }
      button { margin-top:12px; background:#2a5bd7; border:1px solid #2a5bd7; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer }
      button:hover { background:#2f66ef }
    </style>
  </head>
  <body>
    <h3 id="title">Edit Tunnel</h3>
    <div class="wrap">
      <label>Name</label>
      <input id="name" placeholder="Optional name" />
      <label>Session (SSH only)</label>
      <select id="session"></select>
      <div class="row">
        <div>
          <label>Local host</label>
          <input id="lhost" value="127.0.0.1" />
        </div>
        <div>
          <label>Local port</label>
          <input id="lport" value="8080" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Remote host</label>
          <input id="rhost" value="127.0.0.1" />
        </div>
        <div>
          <label>Remote port</label>
          <input id="rport" value="80" />
        </div>
      </div>
      <button id="save">Save</button>
    </div>
    <script>
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search)
        return params.get(name)
      }
      async function loadSshSessions() {
        const sel = document.getElementById('session')
        sel.innerHTML = ''
        let tree = []
        try {
          const res = await window.api.sessionsLoad()
          tree = Array.isArray(res?.tree) ? res.tree : []
        } catch {}
        const sessions = []
        function walk(list) {
          for (const n of list || []) {
            if (!n) continue
            if (n.type === 'folder' && Array.isArray(n.children)) { walk(n.children) }
            else if (n.type === 'session' && n.session && String((n.session.type||'SSH')).toUpperCase() === 'SSH') {
              sessions.push(n)
            }
          }
        }
        walk(tree)
        // Fill select
        for (const n of sessions) {
          const s = n.session || {}
          const opt = document.createElement('option')
          const label = `${s.name || s.host || 'Session'} (${s.username || 'user'})`
          opt.textContent = label
          opt.value = n.id
          opt.dataset.session = encodeURIComponent(JSON.stringify(s))
          sel.appendChild(opt)
        }
        return sessions
      }
      try {
        const presetRaw = getQueryParam('preset')
        if (presetRaw) {
          const t = JSON.parse(decodeURIComponent(presetRaw))
          if (t.name) document.getElementById('name').value = t.name
          if (t.localHost) document.getElementById('lhost').value = t.localHost
          if (t.localPort) document.getElementById('lport').value = String(t.localPort)
          if (t.remoteHost) document.getElementById('rhost').value = t.remoteHost
          if (t.remotePort) document.getElementById('rport').value = String(t.remotePort)
        }
      } catch {}
      // Populate sessions and preselect
      ;(async () => {
        const presetRaw = getQueryParam('preset')
        let preset = {}
        try { preset = JSON.parse(decodeURIComponent(presetRaw)) || {} } catch {}
        const sessions = await loadSshSessions()
        const sel = document.getElementById('session')
        // Try to preselect by sessionId, fallback to host/username match
        let selected = false
        if (preset.sessionId) {
          for (const opt of sel.options) { if (opt.value === preset.sessionId) { opt.selected = true; selected = true; break } }
        }
        if (!selected && preset.sessionCfg) {
          const p = preset.sessionCfg
          for (const opt of sel.options) {
            try {
              const s = JSON.parse(decodeURIComponent(opt.dataset.session || ''))
              if (s && s.host === p.host && s.username === p.username && String(s.port||22) === String(p.port||22)) { opt.selected = true; selected = true; break }
            } catch {}
          }
        }
        // If nothing selected, pick first
        if (!selected && sel.options.length) sel.options[0].selected = true
      })()

      document.getElementById('save').onclick = async () => {
        const name = (document.getElementById('name').value || '').trim()
        const localHost = (document.getElementById('lhost').value || '127.0.0.1').trim()
        const localPort = Number((document.getElementById('lport').value || '0').trim())
        const remoteHost = (document.getElementById('rhost').value || '127.0.0.1').trim()
        const remotePort = Number((document.getElementById('rport').value || '0').trim())
        
        // Validate ports
        if (!localPort || !remotePort || localPort < 1 || localPort > 65535 || remotePort < 1 || remotePort > 65535) { 
          alert('Valid ports (1-65535) are required'); 
          return 
        }
        
        // Validate host addresses
        const hostRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^localhost$|^[a-zA-Z0-9.-]+$/
        if (!hostRegex.test(localHost)) {
          alert('Invalid local host address'); 
          return
        }
        if (!hostRegex.test(remoteHost)) {
          alert('Invalid remote host address'); 
          return
        }
        
        const presetRaw = getQueryParam('preset')
        let base = {}
        try { base = JSON.parse(decodeURIComponent(presetRaw)) || {} } catch {}
        // Session selection
        const sel = document.getElementById('session')
        const sessionId = sel && sel.value
        let sessionCfg = null
        try { sessionCfg = sel && sel.selectedOptions && sel.selectedOptions[0] ? JSON.parse(decodeURIComponent(sel.selectedOptions[0].dataset.session || '')) : null } catch {}
        const out = Object.assign({}, base, { name, localHost, localPort, remoteHost, remotePort, sessionId, sessionCfg })
        try { window.api.tunnelFormSubmit(out) } catch {}
      }
      
      // Handle ESC key to close the tunnel window
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close the window without saving
          try { window.api.tunnelFormSubmit(null) } catch {}
        }
      })
    </script>
  </body>
  </html>

